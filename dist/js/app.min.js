function $one(a){return document.querySelector(a)}function $all(a){return document.querySelectorAll(a)}function getElementIndex(a){for(var b=a.parentNode.childNodes,c=0,d=0;d<b.length;d++){if(b[d]===a)return c;1===b[d].nodeType&&c++}return-1}function init(){$canvas=$one("#canvas"),$score=$one("#score");for(var a="",b=100/size+"%",c=0;c<size*size;c++)a+='<div class="square" style="width: '+b+"; height: "+b+';"><span class="cell" data-value=""></span></div>';$canvas.innerHTML=a,cells=$all(".cell"),attachListeners(),start(),setTimeout(function(){$canvas.classList.remove("hidden")},100)}function start(){selected=[],setScore(0),initGrid(),drawGrid(),$one("body").classList.remove("game-over")}function initGrid(){grid=[];for(var a=0;a<size;a++){grid[a]=new Array(size);for(var b=0;b<size;b++)grid[a][b]=randomSquare()}}function drawGrid(){for(var a=0,b=0;b<size;b++)for(var c=0;c<size;c++)setCellValue(a++,grid[b][c])}function randomSquare(){return Math.ceil(3*Math.random())}function attachListeners(){var a;for($one("#new_game").addEventListener("click",start),$one("#undo").addEventListener("click",undo),a=cells.length-1;a>=0;a--)cells[a].addEventListener(isTouchDevice?"touchstart":"mousedown",function(a){isMouseDown=!0,addSelection(getElementIndex(this.parentElement))});for($canvas.addEventListener(isTouchDevice?"touchmove":"mousemove",function(a){if(isMouseDown){var b=a.pageX||a.touches[0].pageX,c=a.pageY||a.touches[0].pageY,d=document.elementFromPoint(b,c);addSelection(getElementIndex(d.parentElement))}}),a=cells.length-1;a>=0;a--)cells[a].addEventListener(isTouchDevice?"touchend":"mouseup",function(){isMouseDown=!1,evaluateSelected(),selected=[];for(var a=cells.length-1;a>=0;a--)cells[a].classList.remove("selected");isGameOver()&&gameOver()})}function addSelection(a){var b,c=selected.length;if(a!==selected[c-1])return c>1&&(b=selected[c-2],a===b)?(b=selected.pop(),void cells[b].classList.remove("selected")):void(selected.indexOf(a)===-1&&(c>0&&(b=selected[c-1],!isNeighbor(b,a))||(selected.push(a),cells[a].classList.add("selected"))))}function isNeighbor(a,b){var c=Math.abs(a-b);return(1===c||c===size)&&(1!==c||(mod1=a%size,mod2=b%size,1==Math.abs(mod1-mod2)))}function evaluateSelected(){var a,b,c,d,e,f;if(selected.length){for(e=[],b=0;b<selected.length;b++)a=selected[b],d=Math.floor(a/size),c=a%size,e.push(grid[d][c]);for(a=e[0],b=0;b<e.length;b++)if(e[b]!==a)return;for(f=0,b=0;b<e.length;b++)f+=e[b];for(a=selected[selected.length-1],d=Math.floor(a/size),c=a%size,selected.length>1&&(undoHistory={grid:JSON.parse(JSON.stringify(grid)),score:score,steps:1},$one("#undo").removeAttribute("disabled"),setScore(score+f)),grid[d][c]=f,setCellValue(a,f),b=0;b<selected.length-1;b++)a=selected[b],d=Math.floor(a/size),c=a%size,grid[d][c]=randomSquare(),setCellValue(a,grid[d][c])}}function setCellValue(a,b){cells[a].setAttribute("data-value",b),cells[a].innerHTML=b}function isGameOver(){var a,b,c,d;for(b=0;b<size;b++)for(c=0;c<size;c++){d=grid[b][c];try{if(a=grid[b][c-1],d==a)return!1}catch(a){}try{if(a=grid[b][c+1],d==a)return!1}catch(a){}try{if(a=grid[b+1][c],d==a)return!1}catch(a){}try{if(a=grid[b-1][c],d==a)return!1}catch(a){}}return!0}function gameOver(){$one("body").classList.add("game-over")}function setScore(a){if(a<=score||a<2)return score=a,void($score.innerHTML=score);var b=Math.ceil((a-score)/10),c=setInterval(function(){score+=b,score>a&&(score=a),$score.innerHTML=score,score>=a&&clearInterval(c)},30)}function undo(){undoHistory.steps&&(setScore(undoHistory.score),grid=undoHistory.grid,$one("#undo").setAttribute("disabled",!0),drawGrid(),undoHistory={steps:0})}var size=5,undoHistory={},selected,grid,score,cells,$canvas,$score,isMouseDown=!1,isTouchDevice="ontouchstart"in window;init();